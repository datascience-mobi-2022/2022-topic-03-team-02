---
title: "Analysis Part 3"
author: "Mich√®le, Michel, Lennart, Sebastian"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache = TRUE)
library("tidyverse")
```

## load data

```{r}
df_normalized <- readRDS("RDeeP_HeLa_Mitosis_normalized.rds")
df_normalized_combined <- readRDS("RDeeP_HeLa_Mitosis_normalized_combined.rds")
df_global_maxima <- readRDS("RDeeP_HeLa_Mitosis_global_maxima.rds")
df_global_maxima_rep <- readRDS("RDeeP_HeLa_Mitosis_global_maxima_rep.rds")
```

## shift of global maxima > n fractions

After we found the global maxima for every protein, we can continue to use this information to identify RDeeP in our data. For now, we are only using the global maxima, local maxima are found too and might be used later as well.

The first selection criteria for RDeeP is that the shift of the global maximum between RNase and Ctrl conditions must be greater than n fractions (n could be 1, 2, 3,...). To find out a good value for n, we will do the analysis for multiple values and check the quality of the results. For this analysis step, we are going to use the combined data (only one replicate).

We will start to write a function which gives us the shift in fractions for every protein examined.

```{r}
# create vector that will contain the shift in fractions for every protein
shift_global <- c()

# iterate through every protein and calculate how large the shift is
for (i in 1:nrow(df_global_maxima)) {
  
  x <- df_global_maxima[i, 3] - df_global_maxima[i, 1]
  shift_global <- append(shift_global, x)
  
}

# now we can see the shift for every protein
names(shift_global) <- rownames(df_global_maxima)
```

By doing it that way, negative numbers indicate left shifts (shift to lower fractions), while positive numbers indicate right shifts (shift to higher fractions).

```{r}
sum(shift_global < 0) # left shift
sum(shift_global > 0) # right shift 
sum(shift_global == 0) # no shift
```

As we can see, only relying on the global maxima, 5008 proteins do not shift, 1409 proteins have a left shift and 710 proteins have a right shift. Now, we need to select how great the left or right shift must be to make a protein a RDeeP-candidate.

```{r}
for (n in 0:5) {
  
  x <- length(which(shift_global < -n))
  y <- length(which(shift_global > n))
  z <- length(shift_global) - (x + y)
  
  print(x)
  print(y)
  print(z)
  
  print("")
}
```

As expected, the greater we set n to be, the less shifting proteins we identify. Moreover, the number of proteins with no shift increases less every time we increase n by 1. Therefore, the by far greatest decrease of the number of shifting proteins is given when increasing n from 0 to 1. It is clear that a shift of only one fraction can happen in this experiment without the need of a RDeeP, so setting n to be 0 does not make sense. Setting it to 1, 2 or 3 clearly makes a difference, but a much smaller than when increasing n from 0 to 1. 

Anyway, that does not really help us choosing the right value for n. 

n = 1
```{r}
n = 1 # shift must be greater than n
shift_proteins <- c() # in here, the proteins which are shifting are saved
shift_proteins_index <- c()
counter <- 0

for (i in 1:nrow(df_global_maxima)) {
  
  if (shift_global[i] < -n) {
    shift_proteins <- append(shift_proteins, rownames(df_global_maxima)[i])
    shift_proteins_index <- append(shift_proteins_index, i)
  } else if (shift_global[i] > n) {
    shift_proteins <- append(shift_proteins, rownames(df_global_maxima)[i])
    shift_proteins_index <- append(shift_proteins_index, i)
  } else if (shift_global[i] < -n | shift_global[i] > n) {
    counter <- counter + 1
  } 
}

counter # must be zero
length(shift_proteins) # shift proteins gives us the names of the proteins which shift more than 1 fraction
length(shift_proteins_index) # shift proteins index gives us the indices of the shifting proteins
```

Tested and verified!
```{r}
df_test <- df_global_maxima[-shift_proteins_index, ]
shift_global_test <- c()

for (i in 1:nrow(df_test)) {
  x <- df_test[i, 3] - df_test[i, 1]
  shift_global_test <- append(shift_global_test, x)
}
which(shift_global_test > 1)
which(shift_global_test < -1)
```

## significant difference of protein amount at the global maximum (combined)

The second criteria a protein must meet concerns the protein amount. Next to having a great enough shift, we want RDeePs to differ significantly in protein amount between RNase and Ctrl condition at the global maxima (we are using the Ctrl maxima). To test this aspect, we are going to use a student's t-test. The fraction which we test will be given by the combined data, so that we only have one global maxima for each protein. The t-test, however, will be performed using the normalized but not combined data to have three sample for every protein and condition.
The data frame df_global_maxima will give us the fraction we need. The protein amount is saved in df_normalized.

```{r}
pval <- c()

for (i in 1:nrow(df_global_maxima)) {
  
  fraction <- df_global_maxima[i, 1]
  ctrl_vec <- df_normalized[i, c(fraction, fraction + 25, fraction + 50)]
  rnase_vec <- df_normalized[i, c(fraction + 75, fraction + 100, fraction + 125)]
  
  if (abs(sum(ctrl_vec)) > 299.99 & abs(sum(rnase_vec) > 299.99)) {
    pval <- append(pval, 1)
  } else {
    x <- t.test(ctrl_vec, rnase_vec)
    pval <- append(pval, x$p.value)
  }
}

pval_adjust <- p.adjust(pval, method = "fdr")
pval_low <- which(pval_adjust < 0.05)
sig_dif_proteins <- rownames(df_global_maxima)[pval_low]
sig_dif_proteins_index <- pval_low

length(sig_dif_proteins) # names of proteins with significant t test (combined values)
length(sig_dif_proteins_index) # index of proteins with significant t test (combined values)
```

## significant difference of protein amount at the global maximum (replicates)

```{r}
pval_rep <- c()

for (i in 1:nrow(df_global_maxima_rep)) {
  
  ctrl_vec <-
    c(df_normalized[i, df_global_maxima_rep[i, 1]],
      df_normalized[i, df_global_maxima_rep[i, 3] + 25],
      df_normalized[i, df_global_maxima_rep[i, 5] + 50])
  rnase_vec <-
    c(df_normalized[i, df_global_maxima_rep[i, 1] + 75],
      df_normalized[i, df_global_maxima_rep[i, 3] + 100],
      df_normalized[i, df_global_maxima_rep[i, 5] + 125])
  
  if (abs(sum(ctrl_vec)) > 299.99 & abs(sum(rnase_vec) > 299.99)) {
    pval_rep <- append(pval_rep, 1)
  } else {
    x <- t.test(ctrl_vec, rnase_vec)
    pval_rep <- append(pval_rep, x$p.value)
  }
}

pval_adjust_rep <- p.adjust(pval_rep, method = "fdr")
pval_low_rep <- which(pval_adjust_rep < 0.05)
sig_dif_proteins_rep <- rownames(df_normalized)[pval_low_rep]
sig_dif_proteins_index_rep <- pval_low_rep

length(sig_dif_proteins_rep) # names of proteins with significant t test (replicate values)
length(sig_dif_proteins_index_rep) # index of proteins with significant t test (replicate values)
```

## RNA-dependent proteins

```{r}
# combined values
rdeep <- c(intersect(sig_dif_proteins, shift_proteins))
rdeep_index <- c(intersect(sig_dif_proteins_index, shift_proteins_index))

length(rdeep)
length(rdeep_index)

# replicates
rdeep_rep <- c(intersect(sig_dif_proteins_rep, shift_proteins))
rdeep_index_rep <- c(intersect(sig_dif_proteins_index_rep, shift_proteins_index))

length(rdeep_rep)
length(rdeep_index_rep)
```

```{r}
# test whether everything went fine

sum(rownames(df_normalized)[rdeep_index] != rdeep)
sum(rownames(df_normalized)[rdeep_index_rep] != rdeep_rep)
```

```{r}
df_rdeep <- data.frame(row.names = rdeep_rep, index = rdeep_index_rep)
saveRDS(df_rdeep, file = "RDeeP_HeLa_Mitosis_rdeep.rds")
```




Edit: Maybe we can also define proteins as RDeeP if their shift is great enough, even if the t-test is not significant (e.g. shift > 8)

```{r}
length(which(shift_global > 8))
x <- which(shift_global > 8)
names(shift_global)[x]
```










