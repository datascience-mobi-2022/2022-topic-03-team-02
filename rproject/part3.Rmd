---
title: "Analysis Part 3"
author: "Mich√®le, Michel, Lennart, Sebastian"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache = TRUE)
library("tidyverse")
```

## load data

```{r}
df_normalized <- readRDS("RDeeP_HeLa_Mitosis_normalized.rds")
df_normalized_combined <- readRDS("RDeeP_HeLa_Mitosis_normalized_combined.rds")
df_global_maxima <- readRDS("RDeeP_HeLa_Mitosis_global_maxima.rds")
```

## shift of global maxima > n fractions

After we found the global maxima for every protein, we can continue to use this information to identify RDeeP in our data. For now, we are only using the global maxima, local maxima are found too and might be used later as well.

The first selection criteria for RDeeP is that the shift of the global maximum between RNase and Ctrl conditions must be greater than n fractions (n could be 1, 2, 3,...). To find out a good value for n, we will do the analysis for multiple values and check the quality of the results. For this analysis step, we are going to use the combined data (only one replicate).

We will start to write a function which gives us the shift in fractions for every protein examined.

```{r}
# create vector that will contain the shift in fractions for every protein
shift_global <- c()

for (i in 1:nrow(df_global_maxima)) {
  
  x <- df_global_maxima[i, 3] - df_global_maxima[i, 1]
  shift_global <- append(shift_global, x)
  
}

names(shift_global) <- rownames(df_global_maxima)
```

By doing it that way, negative numbers indicate left shifts (shift to lower fractions), while positive numbers indicate right shifts (shift to higher fractions).

```{r}
sum(shift_global < 0)
sum(shift_global > 0)
sum(shift_global == 0)
```

As we can see, only relying on the global maxima, 5008 proteins do not shift, 1409 proteins have a left shift and 710 proteins have a right shift. Now, we need to select how great the left or right shift must be to make a protein a RDeeP-candidate.

```{r}
for (n in 0:5) {
  
  x <- length(which(shift_global < -n))
  y <- length(which(shift_global > n))
  z <- length(shift_global) - (x + y)
  
  print(x)
  print(y)
  print(z)
  
  print("")
}
```

As expected, the greater we set n to be, the less shifting proteins we identify. Moreover, the number of proteins with no shift increases less every time we increase n by 1. Therefore, the by far greatest decrease of the number of shifting proteins is given when increasing n from 0 to 1. It is clear that a shift of only one fraction can happen in this experiment without the need of a RDeeP, so setting n to be 0 does not make sense. Setting it to 1, 2 or 3 clearly makes a difference, but a much smaller than when increasing n from 0 to 1. 

Anyway, that does not really help us choosing the right value for n. 

n = 1
```{r}
shift_proteins <- c()

for (i in 1:nrow(df_global_maxima)) {
  
  if (shift_global[i] < -1) {
    shift_proteins <- append(shift_proteins, rownames(df_global_maxima)[i])
  } else if (shift_global[i] > 1) {
    shift_proteins <- append(shift_proteins, rownames(df_global_maxima)[i])
  }
  
}

length(shift_proteins)
```

## significant difference of protein amount at the global maximum

The second criteria a protein must meet concerns the protein amount. Next to having a great enough shift, we want RDeePs to differ significantly in protein amount between RNase and Ctrl condition at the global maxima (we are using the Ctrl maxima). To test this aspect, we are going to use a student's t-test. The fraction which we test will be given by the combined data, so that we only have one global maxima for each protein. The t-test, however, will be performed using the normalized but not combined data to have three sample for every protein and condition.
The data frame df_global_maxima will give us the fraction we need. The protein amount is saved in df_normalized.


```{r}
sig_dif_proteins <- c()

for (i in 1:nrow(df_global_maxima)) {
  
  fraction <- df_global_maxima[i, 1]
  ctrl_vec <- df_normalized[1, c(fraction, fraction + 25, fraction + 50)]
  rnase_vec <- df_normalized[1, c(fraction + 75, fraction + 100, fraction + 125)]
  x <- t.test(ctrl_vec, rnase_vec)
  
  if (x$p.value < 0.05) {
    sig_dif_proteins <- append(sig_dif_proteins, rownames(df_global_maxima)[i])
  }
}

length(sig_dif_proteins)
```

## RNA-dependent proteins

```{r}
rdeep <- c(intersect(sig_dif_proteins, shift_proteins))
length(rdeep)
```




















