---
title: "Analysis Part 4"
author: "Mich√®le, Michel, Lennart, Sebastian"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache = TRUE)
library("tidyverse")
library("uwot")
library("factoextra")
```

## Dimension Reduction

Load the normalized and combined data:
```{r}
df_normalized_combined <- readRDS("RDeeP_HeLa_Mitosis_normalized_combined.rds")
df_normalized <- readRDS("RDeeP_HeLa_Mitosis_normalized.rds")
```

Perform pca and umap or only umap or only pca on our data:
```{r}
df <- df_normalized_combined # we can use this variable to easily switch between combined and not combined
  
# df_umap1: pca and umap
pca <- prcomp(df)
df_umap1 <- as.data.frame(umap(pca$x))

# df_umap2 : only umap
df_umap2 <- as.data.frame(umap(df))

# df_pca: only pca
df_pca <- as.data.frame(prcomp(df)$x)
```

Plot the results to see whether they differ or not:
```{r}
ggplot(df_umap1, aes(x = V1, y = V2)) +
  geom_point()

ggplot(df_umap2, aes(x = V1, y = V2)) +
  geom_point()

ggplot(df_pca, aes(x = PC1, y = PC2)) +
  geom_point()
```

Now, we can colour proteins according to their shifting behaviour.
```{r}
n = 1
df_umap <- cbind(df_umap1, matrix(0, nrow(df_normalized_combined), 1))
colnames(df_umap) <- c("V1", "V2", "shift")

for (i in 1:nrow(df_umap)) {
  if (shift_global[i] < -n) {
    df_umap[i, 3] <- "left shift"
  } else if (shift_global[i] > n) {
    df_umap[i, 3] <- "right shift"
  } else {
    df_umap[i, 3] <- "no shift"
  }
}
```

We can also colour proteins according to our results (non-RDeep or RDeeP).
```{r}
for (i in 1:nrow(df_umap)) {
  if (rownames(df_umap)[i] %in% rownames(df_rdeep)) {
    df_umap$rdeep[i] <- "rdeep"
  } else {
    df_umap$rdeep[i] <- "non rdeep"
  }
}
```

```{r}
alpha <- ifelse(df_umap$shift == "no shift", 0.1, 1)

ggplot(df_umap, aes(x = V1, y = V2, color = shift)) +
  geom_point(alpha = alpha) +
  ggtitle("UMAP of normalized and combined data")
```

```{r}
ggplot(df_umap, aes(x = V1, y = V2, color = rdeep)) +
  geom_point() +
  ggtitle("UMAP of normalized and combined data")
```

```{r}
x <- grep("left", df_umap$shift)
y <- grep("right", df_umap$shift)
z <- c(x, y)

df_umap_shift <- df_umap[z, ]
df_umap_no_shift <- df_umap[-z, ]

ggplot(df_umap_shift, aes(x = V1, y = V2, color = shift)) +
  geom_point()
ggplot(df_umap_no_shift, aes(x = V1, y = V2, color = shift)) +
  geom_point()
```

```{r}
n = 1
df_pca_shift <- cbind(df_pca, matrix(0, nrow(df_normalized_combined), 1))
colnames(df_pca_shift)[51] <- "shift"

for (i in 1:nrow(df_pca_shift)) {
  if (shift_global[i] < -n) {
    df_pca_shift[i, 51] <- "left shift"
  } else if (shift_global[i] > n) {
    df_pca_shift[i, 51] <- "right shift"
  } else {
    df_pca_shift[i, 51] <- "no shift"
  }
  
}
```

```{r}
ggplot(df_pca_shift, aes(x = PC1, y = PC2, color = shift)) +
  geom_point()
```


## group proteins according to their shifting behaviour

```{r}
df_global_maxima <- readRDS("RDeeP_HeLa_Mitosis_global_maxima.rds")
```

```{r}
n = 1
df_global_maxima_shift <- cbind(df_global_maxima, matrix(0, nrow(df_normalized_combined), 1))
colnames(df_global_maxima_shift)[5] <- "shift"

for (i in 1:nrow(df_global_maxima_shift)) {
  if (shift_global[i] < -n) {
    df_global_maxima_shift[i, 5] <- "left shift"
  } else if (shift_global[i] > n) {
    df_global_maxima_shift[i, 5] <- "right shift"
  } else {
    df_global_maxima_shift[i, 5] <- "no shift"
  }
  
}
```

```{r}
ggplot(
  df_global_maxima_shift,
  aes(y = ctrl_global_maximum_fraction, x = rnase_global_maximum_fraction, color = shift)) +
  geom_count() +
  ggtitle("shifting behaviour of proteins") +
  xlab("global maximum RNase condition") + ylab("global maximum Ctrl conditions")
```

```{r}
ggplot(
  df_global_maxima_shift,
  aes(y = ctrl_global_maximum_fraction, x = rnase_global_maximum_fraction, color = shift)) +
  geom_jitter() +
  ggtitle("shifting behaviour of proteins") +
  xlab("global maximum RNase condition") + ylab("global maximum Ctrl conditions")
```

## kmeans with protein amount

```{r}
df_cluster <- as.data.frame(cbind(shift_global, pval_adjust_rep))
rownames(df_cluster) <- rownames(df_normalized)

for (i in 1:nrow(df_cluster)) {
  if (rownames(df_cluster)[i] %in% rownames(df_rdeep)) {
    df_cluster$rdeep[i] <- "rdeep"
  } else {
    df_cluster$rdeep[i] <- "non rdeep"
  }
}

df_cluster$ctrl_maximum <- df_global_maxima$ctrl_global_maximum_fraction
df_cluster$rnase_maximum <- df_global_maxima$rnase_global_maximum_fraction
```

```{r}
wss = sapply(2:10, function(x) { 
  kmeans(df_normalized_combined, centers = x, nstart = 100)$tot.withinss
})
plot(2:10, wss, xlab = "numbers of centers", ylab = "total within-cluster sum of squares", type = "b")
```

```{r}
tdf_normalized_combined <- t(df_normalized_combined)
km <- kmeans(df_normalized_combined, centers = 3, nstart = 100)

fviz_cluster(km, data = df_normalized_combined,
             #palette = c("#2E9FDF", "#00AFBB", "#E7B800"), 
             geom = "point",
             ellipse.type = "convex", 
             ggtheme = theme_bw()
             )
```


```{r}
df_cluster$cluster <- as.character(km$cluster)

ggplot(
  df_cluster,
  aes(y = ctrl_maximum, x = rnase_maximum, color = cluster)) +
  geom_count() +
  ggtitle("shifting behaviour of proteins") +
  xlab("global maximum RNase condition") + ylab("global maximum Ctrl conditions")
```

```{r}
df_umap$cluster <- as.character(km$cluster)

ggplot(df_umap, aes(x = V1, y = V2, color = cluster)) +
  geom_point() +
  ggtitle("UMAP of normalized and combined data")
```

## kmeans with shift

```{r}
km2 <- kmeans(df_cluster[,1], centers = 3)
```

```{r}
df_umap$cluster2 <- as.character(km2$cluster)

ggplot(df_umap, aes(x = V1, y = V2, color = cluster2)) +
  geom_point() +
  ggtitle("UMAP of normalized and combined data")
```

```{r}
wss = sapply(2:10, function(x) { 
  kmeans(df_cluster[,1], centers = x, nstart = 100)$tot.withinss
})
plot(2:10, wss, xlab = "numbers of centers", ylab = "total within-cluster sum of squares", type = "b")
```

## more stuff

```{r}
ggplot(df_cluster, aes(x = abs(shift_global), y = pval_adjust_rep, color = rdeep)) +
  geom_count()
```

















