---
title: "Analysis Part 5"
author: "Mich√®le, Michel, Lennart, Sebastian"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache = TRUE)
library("tidyverse")
```

## predict shift with correlation

load data:
```{r}
df_normalized <- readRDS("RDeeP_HeLa_Mitosis_normalized.rds")
df_normalized_combined <- readRDS("RDeeP_HeLa_Mitosis_normalized_combined.rds")
```

RDeePs should have a lower correlation between RNase und Ctrl conditions than non-RDeePs:
```{r}
tdf <- as.data.frame(t(df_normalized_combined))
cor(tdf$EED_HUMAN[1:25], tdf$EED_HUMAN[26:50])  # RDeeP
cor(tdf$`1433B_HUMAN`[1:25], tdf$`1433B_HUMAN`[26:50]) # non-RDeeP
```

Using this, we can try to make a linear regression model.
```{r}
# create df that will contain important information for linear modelling
df_lm <- data.frame(row.names = colnames(tdf))

# add vector containing correlation between rnase and control condition to df
vec_cor <- apply(tdf, 2, function(x) {
  cor(x[1:25], x[26:50])
})
df_lm$correlation <- vec_cor
df_lm$shift <- shift_global
```

To train and test our model with our data, we split it so that 80% of the will train the model and 20% will test it.
```{r}
x <- round(nrow(df_lm) * 0.8)
y <- x + 1
df_lm_train <- df_lm[1:x, ]
df_lm_test <- df_lm[y:nrow(df_lm), ]
```

Now, we can train the model using df_lm_train.
```{r}
linear_model <- lm(shift ~ correlation, data = df_lm_train)
summary(linear_model)
```

We can now check some things to decide whether this model is valid or not (residuals normally distributed, residuals not correlated to explanatory variable).
```{r}
# normal distribution of residuals?
hist(linear_model$residuals, breaks = 20)

qqnorm(linear_model$residuals)
qqline(linear_model$residuals)

## correlation residuals x-values?
cor(df_lm_train$correlation, linear_model$residuals)
plot(df_lm_train$correlation, linear_model$residuals, pch = 20)
```

```{r}
plot(
  df_lm_train$shift,
  linear_model$fitted.values,
  pch = 20,
  col = 'blue',
  xlab = 'Real values',
  ylab = 'Predicted values'
); abline(0, 1, col = "blue", lwd = 5)
```

After we have trained our model, we can test it by using df_lm_test.
```{r}
pm <- predict.lm(linear_model, newdata = df_lm_test, se.fit = TRUE, interval = "confidence")

df_lm_predict <- as.data.frame(cbind(df_lm_test$shift, pm$fit))
```









